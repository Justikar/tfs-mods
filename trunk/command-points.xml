<mod name="command-points" version="1.0" author="slawkens" contact="slawkens@gmail.com" enabled="yes"> 
	<config name="command-points-config"><![CDATA[
		config = {
			pointsRune = {
				enabled = "yes",
				points = 50,
				runeId = 2294
			},

			changeName = {
				enabled = "yes",
				points = 50,
				storage = 70009,
				delay = 30 * 24 * 60 * 60 -- 30 days, in seconds
			},

			changeSex = {
				enabled = "yes",
				points = 20
			},

			removeSkull = {
				enabled = "yes",
				points = 50,
				frags = "yes" -- remove frags too?
			}
		}
	]]></config>

	<lib name="command-points-lib"><![CDATA[
		domodlib('command-points-config')

		config.pointsRune.enabled = getBooleanFromString(config.pointsRune.enabled)
		config.changeName.enabled = getBooleanFromString(config.changeName.enabled)
		config.changeSex.enabled = getBooleanFromString(config.changeSex.enabled)

		config.removeSkull.enabled = getBooleanFromString(config.removeSkull.enabled)
		config.removeSkull.frags = getBooleanFromString(config.removeSkull.frags)

		function getPlayerPoints(cid)
			return getAccountPoints(getPlayerAccountId(cid))
		end

		function doPlayerAddPoints(cid, points)
			return doAccountAddPoints(getPlayerAccountId(cid), points)
		end

		function doPlayerRemovePoints(cid, points)
			return doPlayerAddPoints(cid, -points)
		end

		function getAccountPoints(accountId)
			local result = db.getResult('SELECT premium_points FROM accounts WHERE id = ' .. accountId)
			return tonumber(result:getDataInt("premium_points"))
		end

		function doAccountAddPoints(accountId, points)
			return db.executeQuery('UPDATE accounts SET premium_points = premium_points + ' .. points .. ' WHERE id = ' .. accountId)
		end

		command_points = {
			changeName = function (cid)
				if(not getTileInfo(getCreaturePosition(cid)).protection) then
					doPlayerSendTextMessage(cid, MESSAGE_STATUS_CONSOLE_BLUE, "You can use this command only in protection zone.")
					return true
				end

				if(os.time() < getPlayerStorageValue(cid, config.changeName.storage) + config.changeName.delay) then
					doPlayerSendTextMessage(cid, MESSAGE_STATUS_CONSOLE_BLUE, "You can change your name only 1 time per day.")
					return true
				end

				if(getPlayerPoints(cid) < config.changeName.points) then
					doPlayerSendTextMessage(cid, MESSAGE_STATUS_CONSOLE_BLUE, "Sorry, not enought points on your account. Namelock cost " .. config.changeName.points .. " points.")
					return true
				end

				if(doPlayerRemovePoints(cid, config.changeName.points)) then
					setPlayerStorageValue(cid, config.changeName.storage, os.time())
					doAddPlayerBanishment(getCreatureName(cid), BAN_PLAYER, -1, ACTION_NAMELOCK)
					doRemoveCreature(cid)
				else
					doPlayerSendCancel(cid, "ERROR. Please try again later.")
				end
			end,

			changeSex = function (cid)
				if(getPlayerPoints(cid) < config.changeSex.points) then
					doPlayerSendTextMessage(cid, MESSAGE_STATUS_CONSOLE_BLUE, "Sorry, not enought points on your account. Change sex cost " .. config.changeSex.points .. " points.")
					return true
				end
 
				local partner = getPlayerPartner(cid)
				if(partner and partner ~= 0) then
					doPlayerSendTextMessage(cid, MESSAGE_STATUS_CONSOLE_BLUE, "Sorry, you cannot change your sex while being married.")
					return true
				end

				if(doPlayerRemovePoints(cid, config.changeSex.points)) then
					local newSex = getPlayerSex(cid) == PLAYERSEX_FEMALE and PLAYERSEX_MALE or PLAYERSEX_FEMALE
					doPlayerSetSex(cid, newSex)
					doPlayerSendTextMessage(cid, MESSAGE_INFO_DESCR, "Sex changed to " .. (newSex == PLAYERSEX_FEMALE and "female" or "male") .. ".")
					doPlayerSave(cid)
				else
					doPlayerSendCancel(cid, "ERROR. Please try again later.")
				end
			end,

			pointsRune = function (cid)
				if(config.pointsRune.level and getPlayerLevel(cid) < config.pointsRune.level) then
					doPlayerSendTextMessage(cid, MESSAGE_STATUS_CONSOLE_BLUE, "You need " .. config.pointsRune.level .. " level to buy this rune.")
					return true
				end

				if(getPlayerPoints(cid) < config.pointsRune.points) then
					doPlayerSendTextMessage(cid, MESSAGE_STATUS_CONSOLE_BLUE, "Sorry, not enought points on your account. This rune cost " .. config.pointsRune.points .. " points.")
					return true
				end
 
				local item = doCreateItemEx(config.pointsRune.runeId, 1)
				if(not doPlayerAddItemEx(cid, item, false)) then
					doPlayerSendTextMessage(cid, MESSAGE_STATUS_CONSOLE_BLUE, "Not enought space for rune.")
					return true
				end
 
				if(doPlayerRemovePoints(cid, config.pointsRune.points)) then
					doSendMagicEffect(getCreaturePos(cid), 40)
					doPlayerSave(cid)
				else
					doPlayerSendCancel(cid, "ERROR. Please try again later.")
				end
			end,

			removeSkull = function (cid)
				if(getCreatureSkullType(cid) ~= SKULL_RED) then
					doPlayerSendCancel(cid, "You do not have red skull.")
					return true
				end

				if(getPlayerPoints(cid) < config.removeSkull.points) then
					doPlayerSendTextMessage(cid, MESSAGE_STATUS_CONSOLE_BLUE, "Sorry, not enought points on your account. Remove skull cost " .. config.removeFrags.points .. " points.")
					return true
				end

				if(doPlayerRemovePoints(cid, config.pointsRune.points)) then
					doPlayerSendTextMessage(cid, MESSAGE_STATUS_CONSOLE_RED, "Your red skull has been taken off!\nRemaining premium points: " .. getPlayerPoints(cid))
					doCreatureSetSkullType(cid, SKULL_NONE)
					doWriteLogFile("./data/logs/remove_skull.log", "Success: " .. getCreatureName(cid))
					if(config.removeSkull.frags) then
						doPlayerSetRedSkullTicks(cid, 0)
					end

					doSendMagicEffect(getPlayerPosition(cid), CONST_ME_YELLOW_RINGS)
				else
					doPlayerSendCancel(cid, "ERROR. Please try again later.")
				end
			end
		}
	]]></lib>

	<talkaction words="!points" event="script"><![CDATA[
		domodlib('command-points-lib')
		function onSay(cid, words, param, channel)
			if(param == '') then
				doPlayerSendTextMessage(cid, MESSAGE_STATUS_CONSOLE_BLUE, "You have " .. getPlayerPoints(cid) .. " points at your account.")
				return true
			end
 
			param = param:lower():trim()
			if(config.changeName.enabled and isInArray({"namelock", "changename"}, param)) then
				command_points.changeName(cid)
			elseif(config.changeSex.enabled and isInArray({"changesex", "changender", "changegender"}, param)) then
				command_points.changeSex(cid)
			elseif(config.pointsRune.enabled and param == 'rune') then
				command_points.pointsRune(cid)
			elseif(config.removeSkull.enabled and param == 'rs') then
				command_points.removeSkull(cid)
			else
				doPlayerSendTextMessage(cid, MESSAGE_STATUS_CONSOLE_BLUE, "Invalid option.")
			end
			return true
		end
	]]></talkaction>

	<!--talkaction words="!rs" event="script"><![CDATA[
		domodlib('command-points-lib')
		function onSay(cid, words, param, channel)
			command_points.removeSkull(cid)
			return true
		end
	]]></talkaction>

 	<talkaction words="!changename" event="script"><![CDATA[
		domodlib('command-points-lib')
		function onSay(cid, words, param, channel)
			command_points.changeName(cid
			return true
		end
	]]></talkaction>

 	<talkaction words="!changesex" event="script"><![CDATA[
		domodlib('command-points-lib')
		function onSay(cid, words, param, channel)
			command_points.changeSex(cid
			return true
		end
	]]></talkaction-->

	<!-- Points rune -->
	<!-- You can remove/comment below lines if you don't want to use it -->
	<action itemid="2294" allowfaruse="1" blockwalls="1" event="script"><![CDATA[
		domodlib('command-points-lib')
		function onUse(cid, item, fromPosition, itemEx, toPosition)
			if(not isPlayer(itemEx.uid) or not config.pointsRune.enabled) then
				return false
			end

			if(doRemoveItem(item.uid)) then
				doPlayerAddPoints(itemEx.uid, config.pointsRune.points)
				doSendMagicEffect(toPosition, CONST_ME_BIGCLOUDS)
				doPlayerSave(cid)
			else
				doPlayerSendTextMessage(cid, "Points couldn't be added. Please try again later.")
			end

			return true
		end
	]]></action> 
 
	<item id="2294" article="a" name="points rune" override="yes"> 
		<attribute key="runeSpellName" value="Points Rune"/> 
		<attribute key="weight" value="120"/> 
		<attribute key="description" value="50 points. Use it on self or other player to add points."/> 
	</item> 
</mod>

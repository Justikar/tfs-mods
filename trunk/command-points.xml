<mod name="command-points" version="1.0" author="slawkens" contact="slawkens@gmail.com" enabled="yes"> 
	<config name="command-points-config"><![CDATA[
		config = {
			pointsRune = {
				enabled = "yes",
				points = 25,
				runeId = 2294
			},

			changeName = {
				enabled = "yes",
				points = 50,
				storage = 70009,
				delay = 30 * 24 * 60 * 60 --30 days, in seconds
			},

			changeSex = {
				enabled = "yes",
				points = 20
			}
		}
	]]></config>

	<lib name="command-points-lib"><![CDATA[
		domodlib('command-points-config')

		config.pointsRune.enabled = getBooleanFromString(config.pointsRune.enabled)
		config.changeName.enabled = getBooleanFromString(config.changeName.enabled)
		config.changeSex.enabled = getBooleanFromString(config.changeSex.enabled)

		function getPlayerPoints(cid)
			return getAccountPoints(getPlayerAccountId(cid))
		end

		function doPlayerAddPoints(cid, points)
			return doAccountAddPoints(getPlayerAccountId(cid), points)
		end

		function getAccountPoints(accountId)
			local result = db.getResult("SELECT `premium_points` FROM `accounts` WHERE `id` = " .. accountId .. ";")
			return tonumber(result:getDataInt("premium_points"))
		end

		function doAccountAddPoints(accountId, points)
			return db.executeQuery("UPDATE `accounts` SET `premium_points` = `premium_points` + " .. points .. " WHERE `id` = " .. accountId .. ";")
		end
	]]></lib>

	<talkaction words="!points" event="script"><![CDATA[
		domodlib('command-points-lib')
		function onSay(cid, words, param, channel)
			if(param == '') then
				doPlayerSendTextMessage(cid, MESSAGE_STATUS_CONSOLE_BLUE, "(PointsMod): You have " .. getPlayerPoints(cid) .. " points at your account.")
				return true
			end
 
			param = param:lower():trim()
			if(config.changeName.enabled and isInArray({"namelock", "changename"}, param)) then
				if(not getTileInfo(getCreaturePosition(cid)).protection) then
					doPlayerSendTextMessage(cid, MESSAGE_STATUS_CONSOLE_BLUE, "(PointsMod): You can use this command only in protection zone.")
					return true
				end
 
				if(os.time() < getPlayerStorageValue(cid, config.changeName.storage) + config.changeName.delay) then
					doPlayerSendTextMessage(cid, MESSAGE_STATUS_CONSOLE_BLUE, "(PointsMod): You can change your name only 1 time per day.")
					return true
				end
 
				if(getPlayerPoints(cid) < config.changeName.points) then
					doPlayerSendTextMessage(cid, MESSAGE_STATUS_CONSOLE_BLUE, "(PointsMod): Sorry, not enought points on your account. Namelock cost " .. config.changeName.points .. " points.")
					return true
				end
 
				if(doPlayerAddPoints(cid, -config.changeName.points)) then
					setPlayerStorageValue(cid, config.changeName.storage, os.time())
					doAddPlayerBanishment(getCreatureName(cid), BAN_PLAYER, -1, ACTION_NAMELOCK)
					doRemoveCreature(cid)
				end
			elseif(config.changeSex.enabled and isInArray({"changesex", "changender", "changegender"}, param)) then
				if(getPlayerPoints(cid) < config.changeSex.points) then
					doPlayerSendTextMessage(cid, MESSAGE_STATUS_CONSOLE_BLUE, "(PointsMod): Sorry, not enought points on your account. Change sex cost " .. config.changeSex.points .. " points.")
					return true
				end
 
				local partner = getPlayerPartner(cid)
				if(partner and partner ~= 0) then
					doPlayerSendTextMessage(cid, MESSAGE_STATUS_CONSOLE_BLUE, "(PointsMod): Sorry, you cannot change your sex while being married.")
					return true
				end
 
				if(doPlayerAddPoints(cid, -config.changeSex.points)) then
					local newSex = getPlayerSex(cid) == PLAYERSEX_FEMALE and PLAYERSEX_MALE or PLAYERSEX_FEMALE
					doPlayerSetSex(cid, newSex)
					doPlayerSendTextMessage(cid, MESSAGE_INFO_DESCR, "(PointsMod): Your sex has been changed to " .. (newSex == PLAYERSEX_FEMALE and "female" or "male") .. ".")
				end
			elseif(config.pointsRune.enabled and param == 'rune') then
				if(config.pointsRune.level and getPlayerLevel(cid) < config.pointsRune.level) then
					doPlayerSendTextMessage(cid, MESSAGE_STATUS_CONSOLE_BLUE, "(PointsMod): You need " .. config.pointsRune.level .. " level to buy this rune.")
					return true
				end
 
				if(getPlayerPoints(cid) < config.pointsRune.points) then
					doPlayerSendTextMessage(cid, MESSAGE_STATUS_CONSOLE_BLUE, "(PointsMod): Sorry, not enought points on your account. This rune cost " .. config.pointsRune.points .. " points.")
					return true
				end
 
				local item = doCreateItemEx(config.pointsRune.runeId, 1)
				if(doPlayerAddItemEx(cid, item, false) ~= RETURNVALUE_NOERROR) then
					doPlayerSendTextMessage(cid, MESSAGE_STATUS_CONSOLE_BLUE, "(PointsMod): Not enought space for rune.")
					return true
				end
 
				if(doPlayerAddPoints(cid, -config.pointsRune.points)) then
					doSendMagicEffect(getCreaturePos(cid), 40)
				end
			end
			return true
		end
	]]></talkaction> 
 
	<!-- Points rune -->
	<!-- You can remove/comment below lines if you don't want to use it -->
	<action itemid="2294" allowfaruse="1" blockwalls="0" event="script"><![CDATA[
		domodlib('command-points-lib')
		function onUse(cid, item, fromPosition, itemEx, toPosition)
			if(not isPlayer(itemEx.uid)) then
				return true
			end

			if(not config.pointsRune.enabled) then
				return false
			end

			if(doRemoveItem(item.uid)) then
				doPlayerAddPoints(itemEx.uid, config.pointsRune.points)
				doSendMagicEffect(toPosition, CONST_ME_BIGCLOUDS)
			else
				doPlayerSendTextMessage(cid, "Points couldn't be added. Please try again later.")
			end

			return true
		end
	]]></action> 
 
	<item id="2294" article="a" name="points rune" override="yes"> 
		<attribute key="runeSpellName" value="Points Rune"/> 
		<attribute key="weight" value="120"/> 
		<attribute key="description" value="25 points."/> 
	</item> 
</mod>

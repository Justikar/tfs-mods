<?xml version="1.0" encoding="UTF-8"?>
<mod name="advance-reward" version="1.0" author="slawkens" contact="slawkens@gmail.com" enabled="yes">
	<config name="advance-reward-config"><![CDATA[
		rewards = {
			{skill = SKILL__LEVEL, level = 100, storage = 3100, item = 2160, count = 30},
			{skill = SKILL_FISHING, level = 20, storage = 3101, item = 3976, count = 100}
			-- more examples
			--{skill = SKILL_SWORD, level = 110, storage = 3102, item = 2400, message = "Take this as a reward for advancing in 120 sword fighting level!", effect = 61}
		}

		-- message player see when getting reward, you can also personalize it for every reward
		message = "Congratulations, you advanced in {SKILL} level {LEVEL} and received {ITEM} as a reward!"

		-- uncomment if you want to see magic effect when reward is added
		--effect = 30 -- magic effect id
	]]></config>

	<event type="advance" name="advance-reward-event" event="script"><![CDATA[
		domodlib('advance-reward-config')

		local config = {
			rewards = rewards,
			message = message,
			effect = effect
		}

		function onAdvance(cid, skill, oldLevel, newLevel)
			for _, reward in pairs(config.rewards) do
				if(reward.skill == skill and newLevel >= reward.level
					and getPlayerStorageValue(cid, reward.storage) ~= 1
					and doPlayerAddItem(cid, reward.item, reward.count or 1) ~= false)
				then
					setPlayerStorageValue(cid, reward.storage, 1)

					local message = reward.message or config.message
					if(message) then
						local t = {
							["NAME"] = getCreatureName(cid),
							["SKILL"] = SKILL_NAMES[skill],
							["OLDLEVEL"] = oldLevel,
							["LEVEL"] = newLevel,
							["ITEM"] = getItemNameById(reward.item)
						}
						doPlayerSendTextMessage(cid, MESSAGE_INFO_DESCR, tostring(message:gsub("{(.-)}", function(v) return t[v] end)))
					end

					local effect = reward.effect or config.effect
					if(effect) then
						doSendMagicEffect(getCreaturePosition(cid), effect)
					end
				end
			end

			return true
		end
	]]></event>

	<event type="login" name="advance-reward-login" event="buffer"><![CDATA[
		registerCreatureEvent(cid, "advance-reward-event")
		_result = true
	]]></event>
</mod>

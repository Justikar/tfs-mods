<?xml version="1.0" encoding="UTF-8"?>
<mod name="login-history" version="1.0" author="slawkens" contact="slawkens@gmail.com" enabled="yes">
	<config name="login-history-config"><![CDATA[
		expires = 30 -- how many days to expire (clean) old logs from history
	]]></config>

	<!--
		CREATE TABLE `login_history`
		(
			`account_id` INT(11) NOT NULL DEFAULT 0,
			`player_id` INT(11) NOT NULL DEFAULT 0,
			`type` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '1 - server, 0 - website',
			`login` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '1 - login, 0 - logout',
			`ip` INT(11) NOT NULL DEFAULT 0,
			`date` INT(11) NOT NULL DEFAULT 0
		) ENGINE = MyISAM;
	-->

	<event type="login" name="login-history-in" event="buffer"><![CDATA[
		db.executeQuery('INSERT INTO login_history (account_id, player_id, type, login, ip, date) VALUES (' .. getPlayerAccountId(cid) .. ', ' .. getPlayerGUID(cid) .. ', 1, 1, ' .. getPlayerIp(cid) .. ', ' .. os.time() .. ')')
		_result = true
	]]></event>

	<event type="logout" name="login-history-out" event="buffer"><![CDATA[
		db.executeQuery('INSERT INTO login_history (account_id, player_id, type, login, ip, date) VALUES (' .. getPlayerAccountId(cid) .. ', ' .. getPlayerGUID(cid) .. ', 1, 0, ' .. getPlayerIp(cid) .. ', ' .. os.time() .. ')')
		_result = true
	]]></event>

	<globalevent name="login-history-clean" type="start" event="buffer"><![CDATA[
		domodlib('login-history-config')
		db.executeQuery('DELETE FROM login_history WHERE date < ' .. (os.time() - config.expires))
		_result = true
	]]></globalevent>
</mod>
